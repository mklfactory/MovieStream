<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustStreamIt - Les Meilleurs Films</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">üé¨ JustStreamIt</a>
        </div>
    </nav>

    <!-- Hero Section - Meilleur Film -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <h1 id="bestMovieTitle" class="display-4 fw-bold mb-4">Chargement...</h1>
                        <p id="bestMovieDescription" class="lead mb-4">D√©couvrez le film le mieux not√© selon IMDB.</p>
                        <button id="bestMovieDetailsBtn" class="btn btn-primary btn-lg me-3">
                            üìñ D√©tails
                        </button>
                    </div>
                </div>
                <div class="col-lg-6 text-center">
                    <img id="bestMoviePoster" src="" alt="Meilleur Film" class="hero-poster d-none">
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mt-5 pt-5">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3">Chargement des films...</p>
        </div>

        <!-- Films les mieux not√©s -->
        <section class="category-section">
            <h2 class="category-title">üèÜ Films les mieux not√©s</h2>
            <div class="movies-carousel">
                <div id="topRatedMovies" class="movies-grid"></div>
                <button id="showMoreTopRated" class="btn btn-outline-light show-more-btn">Voir plus</button>
            </div>
        </section>

        <!-- Cat√©gorie 1 - Action -->
        <section class="category-section">
            <h2 class="category-title">üí• Action</h2>
            <div class="movies-carousel">
                <div id="actionMovies" class="movies-grid"></div>
                <button id="showMoreAction" class="btn btn-outline-light show-more-btn">Voir plus</button>
            </div>
        </section>

        <!-- Cat√©gorie 2 - Comedy -->
        <section class="category-section">
            <h2 class="category-title">üòÇ Com√©die</h2>
            <div class="movies-carousel">
                <div id="comedyMovies" class="movies-grid"></div>
                <button id="showMoreComedy" class="btn btn-outline-light show-more-btn">Voir plus</button>
            </div>
        </section>

        <!-- Cat√©gorie Personnalisable -->
        <section class="category-section">
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <h2 class="category-title">üé≠ Cat√©gorie Personnalis√©e</h2>
                </div>
                <div class="col-md-6">
                    <select id="categorySelector" class="form-select category-selector">
                        <option value="">Choisir une cat√©gorie...</option>
                    </select>
                </div>
            </div>
            <div class="movies-carousel">
                <div id="customCategoryMovies" class="movies-grid"></div>
                <button id="showMoreCustom" class="btn btn-outline-light show-more-btn">Voir plus</button>
            </div>
        </section>
    </div>

    <!-- Modal pour les d√©tails du film -->
    <div class="modal fade" id="movieModal" tabindex="-1" aria-labelledby="movieModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="movieModalLabel">D√©tails du film</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <img id="modalMoviePoster" src="" alt="Affiche du film" class="movie-detail-poster mb-3">
                        </div>
                        <div class="col-md-8">
                            <h3 id="modalMovieTitle" class="mb-3"></h3>
                            <div id="modalMovieDetails">
                                <!-- Les d√©tails seront ins√©r√©s ici dynamiquement -->
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>R√©sum√©</h5>
                            <p id="modalMovieSummary"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration de l'API
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        
        // Variables globales
        let bestMovie = null;
        let topRatedMovies = [];
        let actionMovies = [];
        let comedyMovies = [];
        let customCategoryMovies = [];
        let categories = [];
        
        // √âl√©ments DOM
        const loadingSpinner = document.getElementById('loadingSpinner');
        const movieModal = new bootstrap.Modal(document.getElementById('movieModal'));
        
        // Fonction pour afficher/masquer le spinner
        function toggleSpinner(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }
        
        // Fonction pour faire une requ√™te √† l'API
        async function fetchFromAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Erreur API:', error);
                // Retourner des donn√©es de d√©monstration en cas d'erreur
                return generateMockData(endpoint);
            }
        }
        
        // Fonction pour g√©n√©rer des donn√©es de d√©monstration
        function generateMockData(endpoint) {
            const mockMovie = (id, title, genre = 'Drama', rating = 8.5) => ({
                id: id,
                title: title,
                genres: [genre],
                imdb_score: rating,
                image_url: `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(title)}`,
                description: `Ceci est la description du film "${title}". Un excellent film qui m√©rite d'√™tre vu.`,
                year: 2023,
                rated: 'PG-13',
                directors: ['R√©alisateur Test'],
                actors: ['Acteur 1', 'Acteur 2', 'Acteur 3'],
                duration: 120,
                countries: ['France'],
                worldwide_gross_income: '$100M',
                long_description: `Description d√©taill√©e du film "${title}". Cette ≈ìuvre cin√©matographique explore des th√®mes profonds et captivants √† travers une narration exceptionnelle et des performances d'acteurs remarquables.`
            });
            
            if (endpoint.includes('/titles/?sort_by=-imdb_score')) {
                const count = endpoint.includes('genre=Action') ? 6 : 
                             endpoint.includes('genre=Comedy') ? 6 : 7;
                const genre = endpoint.includes('genre=Action') ? 'Action' : 
                             endpoint.includes('genre=Comedy') ? 'Comedy' : 'Drama';
                
                return {
                    results: Array.from({length: count}, (_, i) => 
                        mockMovie(i + 1, `${genre} Film ${i + 1}`, genre, 8.5 - i * 0.1)
                    )
                };
            }
            
            if (endpoint.includes('/genres/')) {
                return {
                    results: [
                        { name: 'Action' },
                        { name: 'Comedy' },
                        { name: 'Drama' },
                        { name: 'Horror' },
                        { name: 'Romance' },
                        { name: 'Sci-Fi' },
                        { name: 'Thriller' },
                        { name: 'Mystery' }
                    ]
                };
            }
            
            // Film individuel
            return mockMovie(1, 'Film de D√©monstration', 'Drama', 9.2);
        }
        
        // Fonction pour cr√©er une carte de film
        function createMovieCard(movie) {
            return `
                <div class="movie-card" onclick="showMovieDetails(${movie.id})">
                    <div class="movie-poster">${movie.image_url ? `<img src="${movie.image_url}" alt="${movie.title}" style="width:100%; height:100%; object-fit:cover;">` : movie.title}</div>
                    <div class="p-3">
                        <h6 class="mb-2">${movie.title}</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${movie.year || '2023'}</small>
                            <span class="badge bg-warning text-dark">‚òÖ ${movie.imdb_score || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Fonction pour afficher les films dans une section
        function displayMovies(containerId, movies) {
            const container = document.getElementById(containerId);
            if (container && movies.length > 0) {
                container.innerHTML = movies.map(movie => createMovieCard(movie)).join('');
            }
        }
        
        // Fonction pour afficher les d√©tails d'un film dans la modale
        async function showMovieDetails(movieId) {
            try {
                const movie = await fetchFromAPI(`/titles/${movieId}/`);
                
                document.getElementById('modalMovieTitle').textContent = movie.title;
                document.getElementById('modalMoviePoster').src = movie.image_url || `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(movie.title)}`;
                document.getElementById('modalMovieSummary').textContent = movie.long_description || movie.description || 'Aucun r√©sum√© disponible.';
                
                const details = `
                    <p><strong>Genre:</strong> ${movie.genres ? movie.genres.join(', ') : 'N/A'}</p>
                    <p><strong>Date de sortie:</strong> ${movie.year || 'N/A'}</p>
                    <p><strong>Classification:</strong> ${movie.rated || 'N/A'}</p>
                    <p><strong>Score IMDB:</strong> ‚≠ê ${movie.imdb_score || 'N/A'}/10</p>
                    <p><strong>R√©alisateur:</strong> ${movie.directors ? movie.directors.join(', ') : 'N/A'}</p>
                    <p><strong>Acteurs:</strong> ${movie.actors ? movie.actors.join(', ') : 'N/A'}</p>
                    <p><strong>Dur√©e:</strong> ${movie.duration ? movie.duration + ' min' : 'N/A'}</p>
                    <p><strong>Pays:</strong> ${movie.countries ? movie.countries.join(', ') : 'N/A'}</p>
                    <p><strong>Box Office:</strong> ${movie.worldwide_gross_income || 'N/A'}</p>
                `;
                
                document.getElementById('modalMovieDetails').innerHTML = details;
                movieModal.show();
            } catch (error) {
                console.error('Erreur lors du chargement des d√©tails:', error);
            }
        }
        
        // Fonction pour charger les cat√©gories
        async function loadCategories() {
            try {
                const response = await fetchFromAPI('/genres/');
                categories = response.results || [];
                
                const selector = document.getElementById('categorySelector');
                selector.innerHTML = '<option value="">Choisir une cat√©gorie...</option>';
                
                categories.forEach(category => {
                    selector.innerHTML += `<option value="${category.name}">${category.name}</option>`;
                });
            } catch (error) {
                console.error('Erreur lors du chargement des cat√©gories:', error);
            }
        }
        
        // Fonction pour charger les films d'une cat√©gorie personnalis√©e
        async function loadCustomCategory(genre) {
            if (!genre) return;
            
            try {
                const response = await fetchFromAPI(`/titles/?sort_by=-imdb_score&genre=${genre}&page_size=6`);
                customCategoryMovies = response.results || [];
                displayMovies('customCategoryMovies', customCategoryMovies);
            } catch (error) {
                console.error('Erreur lors du chargement de la cat√©gorie personnalis√©e:', error);
            }
        }
        
        // Fonction pour g√©rer les boutons "Voir plus"
        function setupShowMoreButtons() {
            const buttons = ['showMoreTopRated', 'showMoreAction', 'showMoreComedy', 'showMoreCustom'];
            
            buttons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        const container = button.previousElementSibling;
                        const hiddenCards = container.querySelectorAll('.movie-card[style*="display: none"], .movie-card:not([style])');
                        
                        hiddenCards.forEach((card, index) => {
                            if (index < 6) { // Montrer 6 films suppl√©mentaires
                                card.style.display = 'block';
                            }
                        });
                        
                        // Masquer le bouton si tous les films sont visibles
                        if (container.querySelectorAll('.movie-card[style*="display: none"]').length === 0) {
                            button.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        // Fonction principale d'initialisation
        async function initializeApp() {
            toggleSpinner(true);
            
            try {
                // Charger le meilleur film
                const bestMovieResponse = await fetchFromAPI('/titles/?sort_by=-imdb_score&page_size=1');
                if (bestMovieResponse.results && bestMovieResponse.results.length > 0) {
                    bestMovie = bestMovieResponse.results[0];
                    document.getElementById('bestMovieTitle').textContent = bestMovie.title;
                    document.getElementById('bestMovieDescription').textContent = bestMovie.description || 'Film le mieux not√© selon IMDB.';
                    
                    const posterImg = document.getElementById('bestMoviePoster');
                    if (bestMovie.image_url) {
                        posterImg.src = bestMovie.image_url;
                        posterImg.classList.remove('d-none');
                    }
                    
                    // Event listener pour le bouton d√©tails
                    document.getElementById('bestMovieDetailsBtn').addEventListener('click', () => {
                        showMovieDetails(bestMovie.id);
                    });
                }
                
                // Charger les films les mieux not√©s (excluant le meilleur)
                const topRatedResponse = await fetchFromAPI('/titles/?sort_by=-imdb_score&page=2&page_size=6');
                topRatedMovies = topRatedResponse.results || [];
                displayMovies('topRatedMovies', topRatedMovies);
                
                // Charger les films d'action
                const actionResponse = await fetchFromAPI('/titles/?sort_by=-imdb_score&genre=Action&page_size=6');
                actionMovies = actionResponse.results || [];
                displayMovies('actionMovies', actionMovies);
                
                // Charger les com√©dies
                const comedyResponse = await fetchFromAPI('/titles/?sort_by=-imdb_score&genre=Comedy&page_size=6');
                comedyMovies = comedyResponse.results || [];
                displayMovies('comedyMovies', comedyMovies);
                
                // Charger les cat√©gories
                await loadCategories();
                
                // Event listener pour le s√©lecteur de cat√©gorie
                document.getElementById('categorySelector').addEventListener('change', (e) => {
                    loadCustomCategory(e.target.value);
                });
                
                // Configurer les boutons "Voir plus"
                setupShowMoreButtons();
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
            } finally {
                toggleSpinner(false);
            }
        }
        
        // Fonction pour g√©rer le responsive
        function handleResponsive() {
            const movieGrids = document.querySelectorAll('.movies-grid');
            const showMoreBtns = document.querySelectorAll('.show-more-btn');
            
            function updateVisibility() {
                const width = window.innerWidth;
                let visibleCount;
                
                if (width <= 576) {
                    visibleCount = 2; // Mobile
                } else if (width <= 992) {
                    visibleCount = 4; // Tablette
                } else {
                    visibleCount = 6; // Desktop
                }
                
                movieGrids.forEach((grid, gridIndex) => {
                    const cards = grid.querySelectorAll('.movie-card');
                    cards.forEach((card, cardIndex) => {
                        if (cardIndex < visibleCount) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    // Afficher/masquer le bouton "Voir plus"
                    if (showMoreBtns[gridIndex] && cards.length > visibleCount) {
                        showMoreBtns[gridIndex].style.display = width < 993 ? 'block' : 'none';
                    }
                });
            }
            
            window.addEventListener('resize', updateVisibility);
            updateVisibility(); // Appel initial
        }
        
        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            handleResponsive();
        });
        
        // Fonction globale pour les clics sur les films (accessible depuis onclick)
        window.showMovieDetails = showMovieDetails;
    </script>
</body>
</html>